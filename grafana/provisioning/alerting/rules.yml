apiVersion: 1

groups:
  - orgId: 1
    name: Unraid Disk Alerts
    folder: Unraid Monitoring
    interval: 1m
    rules:
      - uid: disk_temp_critical
        title: Critical Disk Temperature
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: unraid_disk_smart_temperature_celsius
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              expression: A
              reducer: last
              refId: B
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    params:
                      - 60
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  type: query
              refId: C
        noDataState: NoData
        execErrState: Alerting
        for: 5m
        annotations:
          description: 'Disk {{ $labels.disk }} temperature is {{ $values.B.Value }}째C (threshold: 60째C)'
          summary: Critical disk temperature detected
        labels:
          severity: critical

      - uid: disk_temp_warning
        title: High Disk Temperature
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: unraid_disk_smart_temperature_celsius
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              expression: A
              reducer: last
              refId: B
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    params:
                      - 50
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  type: query
              refId: C
        noDataState: NoData
        execErrState: OK
        for: 10m
        annotations:
          description: 'Disk {{ $labels.disk }} temperature is {{ $values.B.Value }}째C (threshold: 50째C)'
          summary: High disk temperature warning
        labels:
          severity: warning

      - uid: smart_health_failed
        title: SMART Health Check Failed
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: unraid_disk_smart_health
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              expression: A
              reducer: last
              refId: B
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    params:
                      - 1
                    type: lt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  type: query
              refId: C
        noDataState: NoData
        execErrState: Alerting
        for: 1m
        annotations:
          description: 'Disk {{ $labels.disk }} ({{ $labels.device }}) has FAILED SMART health check!'
          summary: CRITICAL - Disk SMART health check failed
        labels:
          severity: critical

      - uid: disk_space_critical
        title: Disk Space Critical
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: (unraid_disk_used_bytes / unraid_disk_size_bytes) * 100
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              expression: A
              reducer: last
              refId: B
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    params:
                      - 95
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  type: query
              refId: C
        noDataState: NoData
        execErrState: OK
        for: 5m
        annotations:
          description: 'Disk {{ $labels.disk }} is {{ $values.B.Value }}% full (threshold: 95%)'
          summary: Disk space critically low
        labels:
          severity: critical

      - uid: disk_space_warning
        title: Disk Space Warning
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: (unraid_disk_used_bytes / unraid_disk_size_bytes) * 100
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              expression: A
              reducer: last
              refId: B
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    params:
                      - 85
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  type: query
              refId: C
        noDataState: NoData
        execErrState: OK
        for: 15m
        annotations:
          description: 'Disk {{ $labels.disk }} is {{ $values.B.Value }}% full (threshold: 85%)'
          summary: Disk space running low
        labels:
          severity: warning

      - uid: reallocated_sectors
        title: Reallocated Sectors Detected
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: unraid_disk_smart_reallocated_sectors
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              expression: A
              reducer: last
              refId: B
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  type: query
              refId: C
        noDataState: NoData
        execErrState: OK
        for: 5m
        annotations:
          description: 'Disk {{ $labels.disk }} has {{ $values.B.Value }} reallocated sectors - disk may be failing'
          summary: Reallocated sectors detected - potential disk failure
        labels:
          severity: warning

      - uid: array_stopped
        title: Unraid Array Stopped
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: unraid_array_state
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              expression: A
              reducer: last
              refId: B
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    params:
                      - 1
                    type: lt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  type: query
              refId: C
        noDataState: NoData
        execErrState: Alerting
        for: 2m
        annotations:
          description: 'Unraid array has stopped unexpectedly!'
          summary: CRITICAL - Unraid array is not running
        labels:
          severity: critical

      - uid: parity_errors
        title: Parity Errors Detected
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: unraid_parity_errors_total
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              expression: A
              reducer: last
              refId: B
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  type: query
              refId: C
        noDataState: NoData
        execErrState: OK
        for: 1m
        annotations:
          description: 'Parity check found {{ $values.B.Value }} errors - data corruption detected!'
          summary: CRITICAL - Parity errors detected
        labels:
          severity: critical
